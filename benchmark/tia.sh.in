#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# Copyright (C) 2025 South Australia Medical Imaging

# Pass the dataset from patient 4 in the SNMMI Lu-177 Dosimetry
# Challenge 2021
# (<https://snmmi.org/Therapy/SNMMI-THERAPY/Dosimetry_Challenge.aspx>)
# through Spider's time-integrated activity (TIA) pipeline.  This
# script is built by passing CMake the flag
# '-DSPIDER_BUILD_BENCHMARKS=ON'.  Running it requires the external
# programs dcm2niix, elastix, and gnuplot.

set -euo pipefail

# This is set by the CMake variable SPIDER_BENCHMARK_SPECTCTS_DIR.
SPECTCTS_DIR="@SPIDER_BENCHMARK_SPECTCTS_DIR@"
# This is set by the CMake variable SPIDER_BENCHMARK_TIA_DIR.
TIA_DIR="@SPIDER_BENCHMARK_TIA_DIR@"
ETC_DIR="@CMAKE_SOURCE_DIR@/etc"
BENCHMARK_DIR="@CMAKE_SOURCE_DIR@/benchmark"

# Remove previous output of this script.
rm -f snmmi-tia*
rm -f spect*
rm -rf output_dir*
rm -f tia.nii
rm -f hist.pdf

# The SPECTs and TIA image in the benchmark dataset are in the form of
# DICOM series.  Convert them into 3D NIfTI files.
dcm2niix -o . -f spect1 "$SPECTCTS_DIR/SPECT_Cts/scan1/spect"
dcm2niix -o . -f spect2 "$SPECTCTS_DIR/SPECT_Cts/scan2/spect"
dcm2niix -o . -f spect3 "$SPECTCTS_DIR/SPECT_Cts/scan3/spect"
dcm2niix -o . -f spect4 "$SPECTCTS_DIR/SPECT_Cts/scan4/spect"
dcm2niix -o . -f snmmi-tia "$TIA_DIR/TIA"

# Register SPECTs to first SPECT.
mkdir output_dir2 output_dir3 output_dir4
elastix -f spect1.nii -m spect2.nii -p "$ETC_DIR/Parameters_Rigid.txt" \
        -out output_dir2
elastix -f spect1.nii -m spect3.nii -p "$ETC_DIR/Parameters_Rigid.txt" \
        -out output_dir3
elastix -f spect1.nii -m spect4.nii -p "$ETC_DIR/Parameters_Rigid.txt" \
        -out output_dir4

# Make Spider's TIA image.
"@CMAKE_BINARY_DIR@/src/spider_make_tia_benchmark" spect1.nii \
                    output_dir2/result.0.nii output_dir3/result.0.nii \
                    output_dir4/result.0.nii

# Compare Spider's TIA image with the one in the benchmark dataset.
"@CMAKE_CURRENT_BINARY_DIR@/log10_ratio" tia.nii snmmi-tia.nii | \
    gnuplot -p "$BENCHMARK_DIR/hist.gp"

echo "Wrote hist.pdf"
